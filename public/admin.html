<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema DestravaCell Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        fetch('/api/check-auth').then(r => { if(r.status !== 200) window.location.href = 'login.html'; });
    </script>
</head>
<body>

    <div class="navbar-admin">
        <div class="logo">Destrava<span class="highlight">Cell</span> Admin</div>
        <button onclick="logout()" class="btn-delete" style="border: 1px solid #ff4444; color: #ff4444;">SAIR</button>
    </div>

    <div class="admin-container">
        
        <div class="tabs">
            <div class="tab-btn active" onclick="abrirAba('compras')"><i class="fas fa-shopping-cart"></i> Compra de Aparelhos</div>
            <div class="tab-btn" onclick="abrirAba('os')"><i class="fas fa-tools"></i> Ordem de Serviço</div>
            <div class="tab-btn" onclick="abrirAba('financeiro')"><i class="fas fa-chart-line"></i> Fluxo de Caixa</div>
        </div>

        <div id="tab-compras" class="tab-content active">
            <div class="form-card">
                <h3 class="section-title">Nova Compra / Recibo</h3>
                <h4 class="sub-title">Dados do Vendedor</h4>
                <div class="form-group"><label>Nome</label><input type="text" id="nome"></div>
                <div class="row-inputs">
                    <div class="form-group"><label>CPF</label><input type="text" id="cpf"></div>
                    <div class="form-group"><label>RG</label><input type="text" id="rg"></div>
                </div>
                <div class="form-group"><label>Endereço</label><input type="text" id="endereco"></div>
                <h4 class="sub-title">Dados do Aparelho</h4>
                <div class="row-inputs">
                    <div class="form-group"><label>Modelo</label><input type="text" id="modelo"></div>
                    <div class="form-group"><label>IMEI</label><input type="text" id="imei"></div>
                </div>
                <div class="row-inputs">
                    <div class="form-group"><label>Valor Pago (R$)</label><input type="number" id="valor"></div>
                    <div class="form-group"><label>Estado</label>
                        <select id="estado">
                            <option value="Excelente">Excelente</option>
                            <option value="Bom">Bom</option>
                            <option value="Regular">Regular</option>
                            <option value="Sucata">Sucata</option>
                        </select>
                    </div>
                </div>
                <label>Assinatura</label>
                <div class="signature-wrapper"><canvas id="signature-pad"></canvas></div>
                <button onclick="signaturePadCompras.clear()" class="btn-clear">Limpar</button>
                <button class="btn-generate" onclick="gerarPDF()">Salvar e Gerar Recibo</button>
            </div>
            <div class="history-section">
                <h3>Histórico</h3>
                <div class="table-responsive"><table id="history-table"><thead><tr><th>Data</th><th>Nome</th><th>Modelo</th><th>Valor</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <div id="tab-os" class="tab-content">
            <button class="btn-primary" onclick="abrirModalOS('novo')" style="width: 100%; margin-bottom: 20px; padding: 15px;">
                <i class="fas fa-plus"></i> NOVA ORDEM DE SERVIÇO
            </button>
            <div class="table-responsive">
                <table id="os-table">
                    <thead><tr><th>OS #</th><th>Cliente</th><th>Aparelho</th><th>Status</th><th>Total (Restante)</th><th>Ações</th></tr></thead>
                    <tbody id="lista-os-body"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-financeiro" class="tab-content">
            <div class="dashboard-cards">
                <div class="card-dash"><span>Saldo</span><h2 id="dash-saldo">R$ 0,00</h2></div>
                <div class="card-dash"><span>Entradas</span><h2 id="dash-entradas" style="color:#00ff88;">R$ 0,00</h2></div>
                <div class="card-dash"><span>Saídas</span><h2 id="dash-saidas" style="color:#ff4444;">R$ 0,00</h2></div>
            </div>
            <div class="form-card" style="margin-top: 20px;">
                <h3>Novo Lançamento Manual</h3>
                <div class="row-inputs">
                    <div class="form-group"><label>Descrição</label><input type="text" id="fin-desc"></div>
                    <div class="form-group"><label>Valor</label><input type="number" id="fin-valor"></div>
                    <div class="form-group"><label>Tipo</label><select id="fin-tipo"><option value="entrada">Entrada</option><option value="saida">Saída</option></select></div>
                </div>
                <button class="btn-primary" onclick="salvarFinanceiro()">Adicionar</button>
            </div>
            <div class="table-responsive"><table id="finance-table"><thead><tr><th>Data</th><th>Desc</th><th>Tipo</th><th>Valor</th><th>Ação</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <div id="modal-os" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-os-title">Nova Ordem de Serviço</h2>
                <button onclick="fecharModalOS()" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="os-id-hidden">

                <h4 class="step-title">1. Cliente e Aparelho</h4>
                <div class="row-inputs">
                    <input type="text" id="os-cliente" placeholder="Nome do Cliente">
                    <input type="text" id="os-tel" placeholder="WhatsApp">
                </div>
                <div class="row-inputs">
                    <input type="text" id="os-modelo" placeholder="Modelo do Aparelho">
                    <input type="text" id="os-imei" placeholder="IMEI">
                </div>
                <div class="row-inputs">
                    <input type="text" id="os-senha" placeholder="Senha">
                    <input type="text" id="os-acessorios" placeholder="Acessórios">
                </div>

                <h4 class="step-title">2. Checklist</h4>
                <div class="checklist-grid">
                    <label class="check-item"><input type="checkbox" id="chk-liga"> Liga</label>
                    <label class="check-item"><input type="checkbox" id="chk-tela"> Tela</label>
                    <label class="check-item"><input type="checkbox" id="chk-touch"> Touch</label>
                </div>
                <textarea id="os-obs" placeholder="Observações..." style="width:100%; margin-top:10px; padding:10px; background:#222; border:1px solid #444; color:#fff;"></textarea>

                <h4 class="step-title">3. Valores</h4>
                <textarea id="os-defeito" placeholder="Defeito Relatado"></textarea>
                <div class="row-inputs">
                    <input type="number" id="os-pecas" placeholder="Peças (R$)">
                    <input type="number" id="os-mao" placeholder="Mão de Obra (R$)">
                </div>
                <div class="row-inputs">
                    <input type="number" id="os-desconto" placeholder="Desconto (R$)">
                    <input type="number" id="os-sinal" placeholder="Sinal / Entrada (R$)">
                </div>
                <div class="total-display">Total: R$ <span id="os-total-display">0,00</span></div>

                <h4 class="step-title" style="margin-top: 20px;">4. Assinatura do Cliente</h4>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button onclick="mostrarTabAssinatura('pc')" class="btn-action" style="flex:1;">Assinar Aqui</button>
                    <button onclick="gerarQRCodeOS()" class="btn-action" style="flex:1;">Gerar QR Code</button>
                </div>
                
                <div id="area-assinatura-pc">
                    <div class="signature-wrapper" style="border: 1px solid #555;"><canvas id="signature-pad-os"></canvas></div>
                    <button onclick="limparAssinaturaOS()" class="btn-clear" style="width:auto; padding:5px 10px;">Limpar</button>
                </div>
                
                <div id="area-assinatura-qr" style="display:none; text-align:center; padding: 20px; background: #fff; border-radius: 10px;">
                    <div id="qrcode-os"></div>
                </div>

            </div>
            <div class="modal-footer">
                <button onclick="salvarOS()" class="btn-primary">SALVAR OS</button>
            </div>
        </div>
    </div>

    <script src="admin-script.js"></script>
</body>
</html>
